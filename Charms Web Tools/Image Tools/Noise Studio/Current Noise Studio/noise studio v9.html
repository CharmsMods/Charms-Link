<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Digital Grain Studio — Updated</title><style>:root{--bg:#000;--fg:#fff;--panel-max:460px;--muted:#8c8c8c;--accent:#2a9df4}*{box-sizing:border-box}body,html{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:monospace}body{padding:16px;display:flex;gap:16px;align-items:flex-start;min-height:100vh}.container{display:flex;gap:16px;width:100%}.controls-panel{flex:0 0 var(--panel-max);max-width:var(--panel-max);min-width:260px;padding:10px;border-right:1px solid rgba(255,255,255,.04)}.controls-panel h1{font-size:18px;margin:0 0 8px 0;text-align:center}.muted{color:var(--muted);font-size:13px}details{border:1px solid rgba(255,255,255,.06);margin-bottom:10px;padding:6px;border-radius:6px;background:0 0}summary{cursor:pointer;font-weight:700;margin:0 0 6px 0;outline:0}.control-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;min-height:32px}.control-row label{flex:0 0 130px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}input[type=range]{flex:1}.control-value{width:86px;padding:4px;text-align:right;background:0 0;color:var(--fg);border:1px solid rgba(255,255,255,.06);font-family:monospace}select.control-value{flex:1;min-width:120px;padding:4px}.row-buttons{display:flex;gap:8px;margin-top:8px}button{background:0 0;color:var(--fg);border:1px solid rgba(255,255,255,.08);padding:8px;cursor:pointer}button:hover{background:rgba(255,255,255,.02)}.preview-column{flex:1 1 auto;min-width:320px;display:flex;flex-direction:column;gap:12px}.preview-top{display:flex;align-items:center;justify-content:space-between;gap:12px}.preview-container{position:relative;border:1px solid rgba(255,255,255,.06);background:#070707;overflow:visible;padding:8px;display:flex;align-items:center;justify-content:center}.main-canvas-wrap{width:100%;display:flex;align-items:center;justify-content:center}#displayCanvas{display:block;border-radius:2px;background:0 0}.overlay-original{position:absolute;top:8px;left:8px;right:8px;bottom:8px;display:flex;align-items:center;justify-content:center;pointer-events:none}.overlay-original canvas{width:100%;height:auto;display:block;opacity:0;transition:opacity 180ms ease}.overlay-original.show canvas{opacity:1}.layer-preview-window{border:1px solid rgba(255,255,255,.06);background:#050505;padding:10px;overflow:auto;width:100%}.layer-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:start}.layer-item{border:1px solid rgba(255,255,255,.03);padding:8px;border-radius:6px;display:flex;flex-direction:column;gap:8px;background:0 0}.layer-title-row{display:flex;align-items:center;justify-content:space-between}.layer-title{color:var(--muted);font-size:13px;margin:0}.layer-canvas{width:100%;height:auto;border:1px solid rgba(255,255,255,.03);background:#0a0a0a;display:block}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:3000}.modal-overlay.show{opacity:1;pointer-events:auto}.modal{background:#111;border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:12px;max-width:92vw;width:880px;max-height:90vh;overflow:auto}@media (max-width:900px){body{padding:10px}.controls-panel{order:2;width:100%}.preview-column{order:1;width:100%}.control-row label{flex:0 0 110px}}</style></head><body><div class="container"><div class="controls-panel"><h1>Digital Grain Studio</h1><p class="muted">Settings (Some Sections Collapsed)</p><div style="margin:10px 0"><label style="font-weight:700;display:block;margin-bottom:6px">Image Upload</label> <input id="imageUpload" type="file" accept="image/*" style="width:100%;padding:8px;box-sizing:border-box"></div><details open><summary>Noise Basics</summary><div class="control-row"><label for="strength">Noise Strength (σ)</label> <input id="strength" type="range" min="0" max="150" step="0.01" value="50"></div><div class="control-row"><label for="noiseType">Noise Type</label> <select id="noiseType" class="control-value"><option value="color">Color</option><option value="grayscale" selected="selected">Grayscale</option><option value="blend">Blend (saturation)</option></select></div><div class="control-row" id="satControls" style="display:flex"><label for="satStrength">Sat Change</label> <input id="satStrength" type="range" min="0" max="4" step="0.01" value="1"></div><div class="control-row" id="satPerNoiseRow" style="display:flex"><label for="satPerNoise">Noise Sat Impact</label> <input id="satPerNoise" type="range" min="-100" max="100" step="0.1" value="0"></div></details><details open><summary>Noise Shape & Blur</summary><div class="control-row"><label for="noiseSize">Noise Size</label> <input id="noiseSize" type="range" min="0" max="1000" step="0.01" value="4"></div><div class="control-row"><label for="blurriness">Blurriness</label> <input id="blurriness" type="range" min="0" max="1000" step="0.01" value="160"></div></details><details open><summary>Blend & Visibility</summary><div class="control-row"><label for="blendMode">Blend Mode</label> <select id="blendMode" class="control-value"><option value="source-over">Normal</option><option value="overlay" selected="selected">Overlay</option><option value="screen">Screen</option><option value="multiply">Multiply</option><option value="lighter">Add</option><option value="difference">Subtract</option></select></div><div class="control-row"><label for="opacity">Noise Opacity</label> <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.25"></div></details><details><summary>Noise Masking</summary><div class="control-row"><label for="enableShadows">Noise in Shadows</label> <input id="enableShadows" type="checkbox" style="transform:scale(1.15)"></div><div class="control-row"><label for="shadowThreshold">Shadow Threshold</label> <input id="shadowThreshold" type="range" min="0" max="1" step="0.0001" value="0.3"></div><div class="control-row"><label for="shadowFade">Shadow Fade</label> <input id="shadowFade" type="range" min="0" max="1" step="0.0001" value="0.2"></div><div style="height:6px"></div><div class="control-row"><label for="enableHighlights">Noise in Highlights</label> <input id="enableHighlights" type="checkbox" style="transform:scale(1.15)"></div><div class="control-row"><label for="highlightThreshold">Highlight Threshold</label> <input id="highlightThreshold" type="range" min="0" max="1" step="0.0001" value="0.7"></div><div class="control-row"><label for="highlightFade">Highlight Fade</label> <input id="highlightFade" type="range" min="0" max="1" step="0.0001" value="0.2"></div></details><details><summary>Image Adjustments</summary><div class="control-row"><label for="brightness">Brightness</label> <input id="brightness" type="range" min="-100" max="100" step="1" value="0"></div><div class="control-row"><label for="contrast">Contrast</label> <input id="contrast" type="range" min="-300" max="300" step="1" value="100"></div><div class="control-row"><label for="saturationAdj">Saturation</label> <input id="saturationAdj" type="range" min="-100" max="100" step="0.1" value="0"></div></details><details><summary>HDR Emulation</summary><div class="control-row"><label for="hdrTolerance">Tolerance</label> <input id="hdrTolerance" type="range" min="0" max="1" step="0.01" value="0.35"></div><div class="control-row"><label for="hdrAmount">Amount (%)</label> <input id="hdrAmount" type="range" min="0" max="100" step="1" value="20"></div></details><details><summary>Transparent Pixels</summary><div class="control-row"><label for="ignoreAlphaToggle">Ignore Transparent Areas</label> <input id="ignoreAlphaToggle" type="checkbox" style="transform:scale(1.15)"></div><div class="control-row"><label for="ignoreAlphaStrength">Ignore Strength</label> <input id="ignoreAlphaStrength" type="range" min="0" max="100" step="1" value="100"></div></details><div style="display:flex;gap:8px;margin-top:8px"><button id="realtimeToggle">Realtime: ON</button> <button id="applyBtn">Apply</button></div><div class="row-buttons" style="margin-top:10px"><button id="helpBtn">Help / Manual</button> <button id="compareBtn">Compare</button> <button id="downloadImage" disabled="disabled">Download Image</button></div></div><div class="preview-column"><div class="preview-top"><h3 style="margin:0">Main Preview (hover to reveal original)</h3><div class="muted">Main preview fills available area and keeps aspect ratio. Wheel scrolling no longer changes blend.</div></div><div id="previewArea" class="preview-container" style="min-height:160px"><div class="main-canvas-wrap" id="canvasWrap" style="width:100%;padding:8px 0"><canvas id="displayCanvas"></canvas></div><div class="overlay-original" id="overlayOriginal"><canvas id="overlayCanvas"></canvas></div></div><div class="preview-top"><h3 style="margin:0">Layers & Mask Preview</h3><div class="muted">All layers live inside this single window below the main preview</div></div><div id="layerPreviewWindow" class="layer-preview-window" style="max-height:60vh"><div id="layerGrid" class="layer-grid"></div></div><div class="row-buttons" style="margin-top:10px"><button id="exportLayersBtn">Export Layers</button></div></div></div><div id="compareModal" class="modal-overlay" aria-hidden="true"><div class="modal" role="dialog" aria-modal="true" aria-labelledby="compareTitle"><h2 id="compareTitle">Compare — Original vs Edited</h2><div style="display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap"><canvas id="compareOriginal" style="border:1px solid #333;background:#000"></canvas><canvas id="compareEdited" style="border:1px solid #333;background:#000"></canvas></div><div style="display:flex;gap:8px;justify-content:center;margin-top:12px"><button id="exportSideBySide">Export Side-by-Side</button> <button id="exportStacked">Export Stacked</button> <button id="closeCompare">Close</button></div></div></div><div id="layersModal" class="modal-overlay" aria-hidden="true"><div class="modal" role="dialog" aria-modal="true" aria-labelledby="layersTitle"><h2 id="layersTitle">Export Layers</h2><div style="display:flex;gap:8px;justify-content:center;margin-top:12px"><button id="exportLayersSide">Export Side-by-Side</button> <button id="exportLayersGrid">Export Grid (2x4)</button> <button id="closeLayers">Close</button></div></div></div><script>const fileInput=document.getElementById("imageUpload"),displayCanvas=document.getElementById("displayCanvas"),overlayCanvas=document.getElementById("overlayCanvas"),overlayWrap=document.getElementById("overlayOriginal"),strengthRange=document.getElementById("strength"),noiseTypeSelect=document.getElementById("noiseType"),satStrength=document.getElementById("satStrength"),satPerNoise=document.getElementById("satPerNoise"),noiseSizeRange=document.getElementById("noiseSize"),blurrinessRange=document.getElementById("blurriness"),enableShadows=document.getElementById("enableShadows"),shadowThreshold=document.getElementById("shadowThreshold"),shadowFade=document.getElementById("shadowFade"),enableHighlights=document.getElementById("enableHighlights"),highlightThreshold=document.getElementById("highlightThreshold"),highlightFade=document.getElementById("highlightFade"),blendModeSelect=document.getElementById("blendMode"),opacityRange=document.getElementById("opacity"),brightnessRange=document.getElementById("brightness"),contrastRange=document.getElementById("contrast"),saturationAdjRange=document.getElementById("saturationAdj"),hdrTolerance=document.getElementById("hdrTolerance"),hdrAmount=document.getElementById("hdrAmount"),ignoreAlphaToggle=document.getElementById("ignoreAlphaToggle"),ignoreAlphaStrength=document.getElementById("ignoreAlphaStrength"),layerGrid=document.getElementById("layerGrid"),layerPreviewWindow=document.getElementById("layerPreviewWindow"),realtimeToggle=document.getElementById("realtimeToggle"),applyBtn=document.getElementById("applyBtn"),helpBtn=document.getElementById("helpBtn"),compareBtn=document.getElementById("compareBtn"),downloadBtn=document.getElementById("downloadImage"),exportLayersBtn=document.getElementById("exportLayersBtn"),compareModal=document.getElementById("compareModal"),compareOriginal=document.getElementById("compareOriginal"),compareEdited=document.getElementById("compareEdited"),exportSideBySideBtn=document.getElementById("exportSideBySide"),exportStackedBtn=document.getElementById("exportStacked"),closeCompareBtn=document.getElementById("closeCompare"),layersModal=document.getElementById("layersModal"),exportLayersSideBtn=document.getElementById("exportLayersSide"),exportLayersGridBtn=document.getElementById("exportLayersGrid"),closeLayersBtn=document.getElementById("closeLayers");let baseImageCanvas=null,adjustedImageData=null,lastNoiseCanvas=null,lastMasks={},previews=[],originalImageLoaded=!1,realtime=!0;const PREVIEW_MAX_W=1920,PREVIEW_MAX_H=1080;let lastFullComposite=null;function clamp(e,a,t){return Math.max(a,Math.min(t,e))}function gaussianRandom(e=0,a=1){let t=0,n=0;for(;0===t;)t=Math.random();for(;0===n;)n=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*n)*a+e}function rgbToHsl(e,a,t){const n=Math.max(e,a,t),o=Math.min(e,a,t);let s,d,i=(n+o)/2;if(n===o)s=d=0;else{const l=n-o;switch(d=i>.5?l/(2-n-o):l/(n+o),n){case e:s=(a-t)/l+(a<t?6:0);break;case a:s=(t-e)/l+2;break;default:s=(e-a)/l+4}s/=6}return{h:s,s:d,l:i}}function hslToRgb(e,a,t){let n,o,s;if(0===a)n=o=s=t;else{const d=(e,a,t)=>(t<0&&(t+=1),t>1&&(t-=1),t<1/6?e+6*(a-e)*t:t<.5?a:t<2/3?e+(a-e)*(2/3-t)*6:e),i=t<.5?t*(1+a):t+a-t*a,l=2*t-i;n=d(l,i,e+1/3),o=d(l,i,e),s=d(l,i,e-1/3)}return{r:n,g:o,b:s}}function smoothstep(e,a,t){e>a&&([e,a]=[a,e]);const n=Math.max(0,Math.min(1,(t-e)/(a-e)));return n*n*(3-2*n)}const MAX_NOISE_SIZE=200,MAX_BLUR=5,SLIDER_MAX=1e3,ZOOM_EXPONENT=3;function noiseSizeFromSlider(e){return 1+199*Math.pow(e/1e3,3)}function blurFromSlider(e){return 5*Math.pow(e/1e3,3)}function maskSliderToValue(e){const a=Math.max(0,Math.min(1,Number(e)));return a*a}function fitMainPreview(){if(!originalImageLoaded)return;const e=displayCanvas.width||(baseImageCanvas?baseImageCanvas.width:1),a=displayCanvas.height||(baseImageCanvas?baseImageCanvas.height:1),t=document.getElementById("previewArea"),n=t.getBoundingClientRect(),o=Math.max(100,n.width-24);let s;if(0===window.scrollY){const e=window.innerHeight-n.top-24;s=Math.max(60,e-16)}else s=.9*window.innerHeight;const d=Math.min(o/e,s/a),i=Math.round(e*d),l=Math.round(a*d);displayCanvas.style.width=i+"px",displayCanvas.style.height=l+"px",overlayCanvas.style.width=i+"px",overlayCanvas.style.height=l+"px",t.style.minHeight=l+24+"px"}function adjustImageData(e){const a=e.width,t=e.height,n=new ImageData(new Uint8ClampedArray(e.data),a,t),o=n.data,s=parseFloat(brightnessRange.value)||0,d=(parseFloat(contrastRange.value)||100)/100,i=1+(parseFloat(saturationAdjRange.value)||0)/100,l=2.55*s,r=parseFloat(hdrTolerance.value)||.35,g=parseFloat(hdrAmount.value)||0;for(let e=0;e<o.length;e+=4){let a=o[e],t=o[e+1],n=o[e+2];const s=.299*a+.587*t+.114*n;a=s+(a-s)*i,t=s+(t-s)*i,n=s+(n-s)*i,a=(a-128)*d+128,t=(t-128)*d+128,n=(n-128)*d+128,a+=l,t+=l,n+=l;const h=(.299*a+.587*t+.114*n)/255;if(h<r){const e=g/100*(1-h/r);a*=1-e,t*=1-e,n*=1-e}o[e]=clamp(a,0,255),o[e+1]=clamp(t,0,255),o[e+2]=clamp(n,0,255)}return n}function generateNoiseFullCanvas(e,a,t){const{std:n,noiseType:o,blurSlider:s,noiseSlider:d,satStrengthVal:i,satPerNoiseVal:l,ignoreAlpha:r,ignoreAlphaStrength:g}=t,h=blurFromSlider(s),m=noiseSizeFromSlider(d),c=Math.max(1,Math.round(e/m)),u=Math.max(1,Math.round(a/m)),p=document.createElement("canvas");p.width=c,p.height=u;const v=p.getContext("2d"),w=v.createImageData(c,u),y=w.data,I="color"===o;for(let e=0;e<u;e++)for(let a=0;a<c;a++){const t=4*(e*c+a);let o=128+gaussianRandom(0,n),s=128+gaussianRandom(0,n),d=128+gaussianRandom(0,n);I||(o=s=d),y[t]=clamp(o,0,255),y[t+1]=clamp(s,0,255),y[t+2]=clamp(d,0,255),y[t+3]=255}v.putImageData(w,0,0);const C=document.createElement("canvas");C.width=e,C.height=a;const b=C.getContext("2d");if(b.imageSmoothingEnabled=!0,h>0?(b.filter=`blur(${h}px)`,b.drawImage(p,0,0,e,a),b.filter="none"):b.drawImage(p,0,0,e,a),"blend"===o){const n=b.getImageData(0,0,e,a),o=t.baseData,s=b.createImageData(e,a);for(let e=0;e<s.data.length;e+=4){const a=2*(n.data[e]/255-.5)*((i||1)*(1+(l||0)/100)),t=rgbToHsl(o[e]/255,o[e+1]/255,o[e+2]/255);t.s=clamp(t.s+a,0,2);const d=hslToRgb(t.h,t.s,t.l);s.data[e]=Math.round(255*d.r),s.data[e+1]=Math.round(255*d.g),s.data[e+2]=Math.round(255*d.b),s.data[e+3]=255}b.putImageData(s,0,0)}if(enableShadows&&enableHighlights&&(enableShadows.checked||enableHighlights.checked||r)){const n=b.getImageData(0,0,e,a),o=n.data,s=t.baseData||(baseImageCanvas?baseImageCanvas.getContext("2d").getImageData(0,0,e,a).data:null),d=maskSliderToValue(parseFloat(shadowThreshold.value||.3)),i=maskSliderToValue(parseFloat(shadowFade.value||.2)),l=maskSliderToValue(parseFloat(highlightThreshold.value||.7)),h=maskSliderToValue(parseFloat(highlightFade.value||.2));for(let e=0;e<o.length;e+=4){const a=.299*(s[e]/255)+.587*(s[e+1]/255)+.114*(s[e+2]/255);let t=0,n=0;if(enableShadows.checked){t=1-smoothstep(d-i/2,d+i/2,a)}if(enableHighlights.checked){n=smoothstep(l-h/2,l+h/2,a)}let m=Math.max(t,n);if(r&&baseImageCanvas){m*=1-g*(1-1)}o[e+3]=Math.round(255*m)}b.putImageData(n,0,0)}return C}function composeAndRender(){if(!originalImageLoaded)return;const e={std:parseFloat(strengthRange.value)||0,noiseType:noiseTypeSelect.value,blurSlider:parseFloat(blurrinessRange.value)||0,noiseSlider:parseFloat(noiseSizeRange.value)||1,satStrengthVal:parseFloat(satStrength.value)||1,satPerNoiseVal:parseFloat(satPerNoise.value)||0,ignoreAlpha:ignoreAlphaToggle.checked,ignoreAlphaStrength:(parseFloat(ignoreAlphaStrength.value)||100)/100},a=baseImageCanvas.width,t=baseImageCanvas.height,n=baseImageCanvas.getContext("2d").getImageData(0,0,a,t);adjustedImageData=adjustImageData(n);const o=Object.assign({},e,{baseData:adjustedImageData.data}),s=generateNoiseFullCanvas(a,t,o);lastNoiseCanvas=s;const d=document.createElement("canvas");d.width=a,d.height=t;const i=d.getContext("2d");i.putImageData(adjustedImageData,0,0),i.globalAlpha=parseFloat(opacityRange.value)||1,i.globalCompositeOperation=blendModeSelect.value||"source-over",i.drawImage(s,0,0),i.globalAlpha=1,i.globalCompositeOperation="source-over",displayCanvas.width=a,displayCanvas.height=t;const l=displayCanvas.getContext("2d");l.clearRect(0,0,a,t),l.drawImage(d,0,0),overlayCanvas.width=a,overlayCanvas.height=t;const r=overlayCanvas.getContext("2d");return r.clearRect(0,0,a,t),r.drawImage(baseImageCanvas,0,0),buildMasks(a,t),buildLayerGrid(d,s,{baseCanvas:baseImageCanvas,adjustedCanvas:function(){const e=document.createElement("canvas");return e.width=a,e.height=t,e.getContext("2d").putImageData(adjustedImageData,0,0),e}(),masks:lastMasks}),lastFullComposite=d,fitMainPreview(),downloadBtn&&(downloadBtn.disabled=!1),{compositeCanvas:d,baseCanvas:baseImageCanvas,adjustedCanvas:null,noiseCanvas:s,masks:lastMasks}}function buildMasksFromImageData(e,a,t){const n=document.createElement("canvas");n.width=a,n.height=t;const o=document.createElement("canvas");o.width=a,o.height=t;const s=document.createElement("canvas");s.width=a,s.height=t;const d=n.getContext("2d"),i=o.getContext("2d"),l=s.getContext("2d"),r=d.createImageData(a,t),g=i.createImageData(a,t),h=l.createImageData(a,t),m=maskSliderToValue(parseFloat(shadowThreshold.value||.3)),c=maskSliderToValue(parseFloat(shadowFade.value||.2)),u=maskSliderToValue(parseFloat(highlightThreshold.value||.7)),p=maskSliderToValue(parseFloat(highlightFade.value||.2)),v=e.data;for(let e=0;e<v.length;e+=4){const a=.299*(v[e]/255)+.587*(v[e+1]/255)+.114*(v[e+2]/255);let t=0,n=0;if(enableShadows&&enableShadows.checked){t=1-smoothstep(m-c/2,m+c/2,a)}if(enableHighlights&&enableHighlights.checked){n=smoothstep(u-p/2,u+p/2,a)}const o=Math.max(t,n),s=Math.round(255*t),d=Math.round(255*n),i=Math.round(255*o);r.data[e]=r.data[e+1]=r.data[e+2]=s,r.data[e+3]=255,g.data[e]=g.data[e+1]=g.data[e+2]=d,g.data[e+3]=255,h.data[e]=h.data[e+1]=h.data[e+2]=i,h.data[e+3]=255}d.putImageData(r,0,0),i.putImageData(g,0,0),l.putImageData(h,0,0),lastMasks={shadows:n,highlights:o,combined:s}}function buildLayerGrid(e,a,t){layerGrid.innerHTML="",previews=[];e.width,e.height;const n=t&&t.baseCanvas?t.baseCanvas:baseImageCanvas,o=t&&t.adjustedCanvas?t.adjustedCanvas:function(){const e=document.createElement("canvas");return adjustedImageData&&(e.width=adjustedImageData.width,e.height=adjustedImageData.height,e.getContext("2d").putImageData(adjustedImageData,0,0)),e}(),s=t&&t.masks?t.masks:lastMasks;function d(e,a){const t=document.createElement("div");t.className="layer-item";const n=document.createElement("div");n.className="layer-title-row";const o=document.createElement("div");o.className="layer-title",o.textContent=e;const s=document.createElement("div"),d=document.createElement("button");d.textContent="Download",d.title="Download full-resolution PNG",s.appendChild(d),n.appendChild(o),n.appendChild(s);const i=document.createElement("canvas");i.className="layer-canvas",i.style.width="100%",i.style.height="auto",d.addEventListener("click",()=>{const t=document.createElement("canvas");t.width=a.width,t.height=a.height,t.getContext("2d").drawImage(a,0,0);const n=document.createElement("a");n.href=t.toDataURL("image/png"),n.download=`${e.replace(/\s+/g,"_").toLowerCase()}.png`,n.click()}),t.appendChild(n),t.appendChild(i),layerGrid.appendChild(t),previews.push({name:e,canvas:i,src:a,item:t})}n&&d("Base Original",n),o&&o.width&&d("Adjusted (with HDR)",o),o&&o.width&&d("HDR Emulation Result",o),a&&d("Noise Layer",a),s&&s.combined&&d("Mask (combined)",s.combined),s&&s.shadows&&d("Shadows Mask",s.shadows),s&&s.highlights&&d("Highlights Mask",s.highlights),e&&d("Composite (Edited)",e);const i=previews.length;if(i>0){const e=Math.ceil(i/2),a=100;layerGrid.style.gridTemplateColumns=`repeat(${e}, minmax(${a}px, 1fr))`}layerPreviewWindow.style.maxHeight=Math.max(200,Math.min(window.innerHeight,Math.round(.9*window.innerHeight)))+"px",layerPreviewWindow.style.overflow="auto",updateLayerPreviews()}function updateLayerPreviews(){if(0===previews.length)return;const e=window.devicePixelRatio||1;previews.forEach(a=>{const t=a.canvas.getBoundingClientRect();if(t.width<=0||t.height<=0)return;const n=a.src.width,o=a.src.height,s=t.width*e,d=t.height*e,i=Math.min(s,n),l=Math.min(d,o);a.canvas.width=i,a.canvas.height=l;const r=a.canvas.getContext("2d");r.clearRect(0,0,i,l);const g=i/t.width,h=l/t.height;r.scale(g,h),r.drawImage(a.src,0,0,n,o,0,0,t.width,t.height)})}function buildMasks(e,a){if(!adjustedImageData)return;const t=document.createElement("canvas");t.width=e,t.height=a;const n=document.createElement("canvas");n.width=e,n.height=a;const o=document.createElement("canvas");o.width=e,o.height=a;const s=t.getContext("2d"),d=n.getContext("2d"),i=o.getContext("2d"),l=adjustedImageData.data,r=s.createImageData(e,a),g=d.createImageData(e,a),h=i.createImageData(e,a),m=maskSliderToValue(parseFloat(shadowThreshold.value||.3)),c=maskSliderToValue(parseFloat(shadowFade.value||.2)),u=maskSliderToValue(parseFloat(highlightThreshold.value||.7)),p=maskSliderToValue(parseFloat(highlightFade.value||.2));for(let e=0;e<l.length;e+=4){const a=.299*(l[e]/255)+.587*(l[e+1]/255)+.114*(l[e+2]/255);let t=0,n=0;if(enableShadows&&enableShadows.checked){t=1-smoothstep(m-c/2,m+c/2,a)}if(enableHighlights&&enableHighlights.checked){n=smoothstep(u-p/2,u+p/2,a)}const o=Math.max(t,n),s=Math.round(255*t),d=Math.round(255*n),i=Math.round(255*o);r.data[e]=r.data[e+1]=r.data[e+2]=s,r.data[e+3]=255,g.data[e]=g.data[e+1]=g.data[e+2]=d,g.data[e+3]=255,h.data[e]=h.data[e+1]=h.data[e+2]=i,h.data[e+3]=255}s.putImageData(r,0,0),d.putImageData(g,0,0),i.putImageData(h,0,0),lastMasks={shadows:t,highlights:n,combined:o}}function setupUIListeners(){[strengthRange,noiseTypeSelect,satStrength,satPerNoise,noiseSizeRange,blurrinessRange,enableShadows,shadowThreshold,shadowFade,enableHighlights,highlightThreshold,highlightFade,blendModeSelect,opacityRange,brightnessRange,contrastRange,saturationAdjRange,hdrTolerance,hdrAmount,ignoreAlphaToggle,ignoreAlphaStrength].filter(Boolean).forEach(e=>{e.addEventListener("input",e=>{realtime&&composeAndRender()}),e.addEventListener("change",()=>{composeAndRender()})}),realtimeToggle&&realtimeToggle.addEventListener("click",()=>{realtime=!realtime,realtimeToggle.textContent="Instant Update "+(realtime?"ON":"OFF"),applyBtn&&(applyBtn.disabled=realtime),realtime&&composeAndRender()}),applyBtn&&applyBtn.addEventListener("click",()=>{composeAndRender()}),helpBtn&&helpBtn.addEventListener("click",()=>{alert("Quick tips:\n- Hover the main preview to see the original.\n- Realtime applies live updates (ON by default). Turn off to batch changes and press Apply.\n- Click a layer Download to export it at original resolution.\n- Compare opens side-by-side export options.\n- Export Layers opens options to export all layers side-by-side or in a 2x4 grid at full resolution.\n- Layer previews are scaled to fit in at most 2 rows, with resolution matching screen DPI and zoom; on high-resolution displays or high zoom, they render at original image resolution where possible.")}),compareBtn&&compareBtn.addEventListener("click",async()=>{originalImageLoaded&&(await ensureFullQualityComposite(),compareModal.classList.add("show"),compareModal.setAttribute("aria-hidden","false"),drawCompareCanvases())}),closeCompareBtn&&closeCompareBtn.addEventListener("click",()=>{compareModal.classList.remove("show"),compareModal.setAttribute("aria-hidden","true")}),exportSideBySideBtn&&exportSideBySideBtn.addEventListener("click",()=>exportCompare("side")),exportStackedBtn&&exportStackedBtn.addEventListener("click",()=>exportCompare("stack")),exportLayersBtn&&exportLayersBtn.addEventListener("click",async()=>{originalImageLoaded&&(await ensureFullQualityComposite(),layersModal.classList.add("show"),layersModal.setAttribute("aria-hidden","false"))}),closeLayersBtn&&closeLayersBtn.addEventListener("click",()=>{layersModal.classList.remove("show"),layersModal.setAttribute("aria-hidden","true")}),exportLayersSideBtn&&exportLayersSideBtn.addEventListener("click",()=>exportLayers("side")),exportLayersGridBtn&&exportLayersGridBtn.addEventListener("click",()=>exportLayers("grid")),downloadBtn&&downloadBtn.addEventListener("click",async()=>{if(originalImageLoaded&&(await ensureFullQualityComposite(),lastFullComposite)){const e=document.createElement("a");e.href=lastFullComposite.toDataURL("image/png"),e.download="edited_image.png",e.click()}});const e=document.getElementById("previewArea");e&&overlayWrap&&(e.addEventListener("mouseenter",()=>overlayWrap.classList.add("show")),e.addEventListener("mouseleave",()=>overlayWrap.classList.remove("show")))}function ensureFullQualityComposite(){return new Promise(e=>{if(!originalImageLoaded)return void e();const a=realtime;realtime=!1;composeAndRender();realtime=a,e()})}function drawCompareCanvases(){if(!baseImageCanvas)return;const e=baseImageCanvas.width,a=baseImageCanvas.height,t=document.querySelector(".modal").getBoundingClientRect(),n=Math.floor((t.width-40)/2),o=Math.min(1,n/e),s=Math.round(e*o),d=Math.round(a*o);compareOriginal.width=s,compareOriginal.height=d,compareEdited.width=s,compareEdited.height=d,compareOriginal.getContext("2d").drawImage(baseImageCanvas,0,0,e,a,0,0,s,d);const i=lastFullComposite||displayCanvas;compareEdited.getContext("2d").drawImage(i,0,0,i.width,i.height,0,0,s,d)}function exportCompare(e){if(!baseImageCanvas)return;const a=baseImageCanvas.width,t=baseImageCanvas.height,n=lastFullComposite||displayCanvas;let o;if("side"===e){o=document.createElement("canvas"),o.width=2*a,o.height=t;const e=o.getContext("2d");e.drawImage(baseImageCanvas,0,0),e.drawImage(n,a,0)}else{o=document.createElement("canvas"),o.width=a,o.height=2*t;const e=o.getContext("2d");e.drawImage(baseImageCanvas,0,0),e.drawImage(n,0,t)}const s=document.createElement("a");s.href=o.toDataURL("image/png"),s.download="side"===e?"compare_side_by_side.png":"compare_stacked.png",s.click(),setTimeout(()=>{compareModal.classList.remove("show"),compareModal.setAttribute("aria-hidden","true")},300)}function exportLayers(e){if(0===previews.length||!baseImageCanvas)return;const a=baseImageCanvas.width,t=baseImageCanvas.height,n=previews.length;let o;if("side"===e){o=document.createElement("canvas"),o.width=a*n,o.height=t;const e=o.getContext("2d");previews.forEach((t,n)=>{e.drawImage(t.src,n*a,0)})}else if("grid"===e){o=document.createElement("canvas"),o.width=2*a,o.height=4*t;const e=o.getContext("2d");previews.forEach((n,o)=>{const s=o%2,d=Math.floor(o/2);e.drawImage(n.src,s*a,d*t)})}const s=document.createElement("a");s.href=o.toDataURL("image/png"),s.download="side"===e?"layers_side_by_side.png":"layers_grid.png",s.click(),setTimeout(()=>{layersModal.classList.remove("show"),layersModal.setAttribute("aria-hidden","true")},300)}function loadImage(e){const a=e.naturalWidth||e.width,t=e.naturalHeight||e.height;baseImageCanvas=document.createElement("canvas"),baseImageCanvas.width=a,baseImageCanvas.height=t,baseImageCanvas.getContext("2d").drawImage(e,0,0,a,t),originalImageLoaded=!0,displayCanvas.width=a,displayCanvas.height=t,overlayCanvas.width=a,overlayCanvas.height=t,composeAndRender()}fileInput.addEventListener("change",e=>{const a=e.target.files&&e.target.files[0];if(!a)return;const t=new FileReader;t.onload=e=>{const a=new Image;a.onload=()=>loadImage(a),a.src=e.target.result},t.readAsDataURL(a)}),function(){function e(){const e=noiseTypeSelect.value;document.getElementById("satControls").style.display="blend"===e?"flex":"none",document.getElementById("satPerNoiseRow").style.display="blend"===e?"flex":"none"}noiseTypeSelect.addEventListener("change",()=>{e(),realtime&&composeAndRender()}),e(),setupUIListeners(),realtimeToggle&&(realtimeToggle.textContent="Instant Update: ON"),applyBtn&&(applyBtn.disabled=!0),window.addEventListener("resize",()=>{fitMainPreview(),layerPreviewWindow.style.maxHeight=Math.max(200,Math.min(window.innerHeight,Math.round(.9*window.innerHeight)))+"px",updateLayerPreviews()}),window.addEventListener("scroll",()=>{fitMainPreview()})}()</script></body></html>