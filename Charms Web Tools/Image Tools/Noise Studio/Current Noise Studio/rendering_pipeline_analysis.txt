# TECHNICAL ANALYSIS: Noise Studio Rendering Pipeline (v19v2.html)

This document provides a detailed breakdown of the image processing pipeline, resolution management, and internal scaling logic found in the v19v2.html codebase.

## 1. RESOLUTION CLAMPING & SCALING

### A. Preview Mode (Dynamic Downscaling)
- **Component**: `reallocateBuffers(fullRes = false)`
- **Behavior**: If the requested render size (Image Width/Height * Upscale Factor) exceeds 2,048 pixels, the application silently downscales the rendering buffers to fit within a 2,048px bounding box.
- **Purpose**: Performance and UI responsiveness. It ensures that compute-heavy shaders (Bilateral/Gaussian) can update in real-time as users move sliders.

### B. Export Mode (Full-Res Path)
- **Component**: `reallocateBuffers(true)` and `renderFrame(true)`
- **Behavior**: Ignores the 2,048px preview cap and attempts to allocate textures at the full upscaled resolution.
- **Limitation**: Still clamped by `gl.MAX_TEXTURE_SIZE` (a physical GPU limit). If the requested size exceeds what the hardware can support (e.g., 16,384px), it scales the image down to the maximum supported size.

### C. UI Thumbnails (Fixed Downsampling)
- **Component**: `thumbnailFBO` initialization in `initWebGL`
- **Resolution**: Fixed at 320 x 180 pixels.
- **Behavior**: Used for the 'Layer Breakdown' strip. It takes a raw snapshot of the GPU buffer and downscales it to these small previews to avoid the memory overhead of multiple high-res textures.

## 2. EFFECT-SPECIFIC LOGIC

### A. Procedural Noise Density
- **Shader Variable**: `u_origRes` vs `u_res`
- **Logic**: The noise shader uses the "Original Destination Resolution" (e.g., the 8K target) to calculate grain size, rather than the current buffer resolution.
- **Result**: Grain looks exactly the same density on a 2K preview as it does on a final 8K export (WYSIWYG).

### B. Chromatic Aberration (CA) Control
- **Logic**: Uses a PIN-based coordinate mapping.
- **Coordinate System**: Maps DOM mouse coordinates (relative to the preview box) into normalized 0.0-1.0 UV space for the fragment shader.

### C. Lens Zoom vs. Full Zoom
- **Full Zoom**: Scales the CSS of the 2,048px preview canvas (interpolated/pixelated).
- **Lens Zoom**: Triggers a high-quality re-render (`reallocateBuffers(true)`) for the magnified area, providing a pixel-accurate view of the effect stack.

## 3. PIPELINE ORDER & ARCHITECTURE

- **Logic**: Single-pass per layer using a "Ping-Pong" double buffer system.
- **Order**: `[Noise] -> [Adjust] -> [HDR] -> [CA] -> [Blur] -> [Cell] -> [Halftone] -> [Bilateral] -> [Dither] -> [Palette] -> [Edge] -> [Corruption]`.
- **Note**: The order is customizable via the 'Render Layer Order' drag-and-drop UI, which modifies the `state.renderOrder` array.

## 4. FEEDBACK & OBSERVATIONS

- **Silent Clamping**: The 2,048px preview cap is currently non-obvious to the user.
- **Hardware Variation**: GPU hardware limits create non-deterministic export sizes for power-users (different limits on mobile vs desktop).
- **Eyedropper Inversion**: Uses WebGL `readPixels`, accounting for the fact that WebGL's Y-axis (bottom-up) is inverted relative to the DOM (top-down).

---
*Created on: 2026-01-13*
*Status: Verified and Documented*
