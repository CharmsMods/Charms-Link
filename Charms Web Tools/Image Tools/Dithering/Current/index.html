<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Dither Studio — GPU Dithering Tool (Debug)</title><style>:root{--bg:#0f1720;--panel:#111827;--accent:#38bdf8;--muted:#9ca3af}body,html{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#e6eef6}.app{display:grid;grid-template-columns:360px 1fr;gap:18px;height:100vh;padding:18px;box-sizing:border-box}.panel{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,.6);overflow:auto}h1{font-size:16px;margin:0 0 12px 0}.control{margin-bottom:12px}label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}input[type=range]{width:100%}button,input[type=file],select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:0 0;color:inherit}.canvas-wrap{display:flex;align-items:center;justify-content:center;background:#000;border-radius:12px;overflow:hidden}canvas{max-width:100%;height:auto;width:100%;background:#000;display:block}.row{display:flex;gap:8px}.small{width:48%}.meta{font-size:12px;color:var(--muted);margin-top:6px}.footer{margin-top:12px;font-size:12px;color:var(--muted)}.val{float:right;color:#cbd5e1}</style></head><body><div class="app"><div class="panel" id="controls"><h1>Dither Studio — GPU Dithering (Debug)</h1><div class="control"><label>Load image</label> <input id="file" type="file" accept="image/*"></div><div class="control"><label>Bit depth (per channel) <span class="val" id="bitDepthVal">8</span></label> <input id="bitDepth" type="range" min="0" max="1" step="0.001" value="1"><div class="meta">Mapped exponentially to 1–8 bits for fine low-end control.</div></div><div class="control"><label>Palette mode</label> <select id="paletteMode"><option value="none">None (bit-depth / posterize)</option><option value="auto">Auto (k-means palette)</option></select></div><div class="control"><label>Palette size <span class="val" id="paletteSizeVal">8</span></label> <input id="paletteSize" type="range" min="0" max="1" step="0.001" value="0.2"><div class="meta">When using Auto, the palette will be computed (2–64 colors). Uses sampled k-means on the image.</div></div><div class="control"><label>Dither type</label> <select id="ditherType"><option value="0">None</option><option value="1">Bayer (ordered)</option><option value="2">Noise (random)</option></select></div><div class="control"><label>Dither strength <span class="val" id="ditherStrengthVal">0.75</span></label> <input id="ditherStrength" type="range" min="0" max="1" step="0.001" value="0.75"></div><div class="control row"><div class="small"><label>Scale</label><input id="scale" type="range" min="0.125" max="4" step="0.125" value="1"></div><div class="small"><label>Preserve pixels</label><select id="filterMode"><option value="nearest">Nearest</option><option value="linear">Linear</option></select></div></div><div class="control"><button id="exportBtn">Export PNG</button></div><div class="control row"><div class="small"><button id="debugUVBtn">Toggle Debug UV</button></div><div class="small"><button id="logPixelBtn">Log Center Pixel</button></div></div><div class="footer">If output is solid black: use "Toggle Debug UV" to show UV colors, then use "Log Center Pixel" to inspect RGBA. Check browser console for GL errors.</div></div><div class="panel" style="display:flex;flex-direction:column"><div class="canvas-wrap" style="flex:1"><canvas id="glcanvas"></canvas></div><div style="margin-top:12px;display:flex;gap:12px;align-items:center"><div style="flex:1;color:var(--muted);font-size:12px">Image: <span id="info">No image loaded</span></div><div><button id="fitBtn">Fit to window</button></div></div></div></div><script>function expMap(e,t,r){return t*Math.pow(r/t,e)}function clamp(e,t,r){return Math.max(t,Math.min(r,e))}const fileInput=document.getElementById("file"),canvas=document.getElementById("glcanvas"),info=document.getElementById("info"),bitDepthSlider=document.getElementById("bitDepth"),bitDepthVal=document.getElementById("bitDepthVal"),paletteMode=document.getElementById("paletteMode"),paletteSizeSlider=document.getElementById("paletteSize"),paletteSizeVal=document.getElementById("paletteSizeVal"),ditherType=document.getElementById("ditherType"),ditherStrength=document.getElementById("ditherStrength"),ditherStrengthVal=document.getElementById("ditherStrengthVal"),exportBtn=document.getElementById("exportBtn"),fitBtn=document.getElementById("fitBtn"),scaleSlider=document.getElementById("scale"),filterMode=document.getElementById("filterMode"),debugUVBtn=document.getElementById("debugUVBtn"),logPixelBtn=document.getElementById("logPixelBtn");let gl=null,program=null,imageTexture=null,paletteTexture=null,imageWidth=0,imageHeight=0,loadedImage=null,debugShowUV=0;const MAX_PALETTE=64;function checkGLError(e){if(!gl)return;const t=gl.getError();t!==gl.NO_ERROR&&console.warn(e,"GL ERROR",t)}function initGL(){if(gl=canvas.getContext("webgl2",{antialias:!1,preserveDrawingBuffer:!0,alpha:!1}),!gl)return alert("WebGL2 not supported");const e=createShader(gl.VERTEX_SHADER,"#version 300 es\n  in vec2 a_pos; in vec2 a_uv; out vec2 v_uv; void main(){v_uv=a_uv; gl_Position = vec4(a_pos,0,1);} "),t=createShader(gl.FRAGMENT_SHADER,"#version 300 es\n  precision mediump float;\n  in vec2 v_uv; out vec4 fragColor;\n  uniform sampler2D u_image;\n  uniform sampler2D u_palette;\n  uniform int u_paletteSize;\n  uniform int u_ditherType;\n  uniform float u_ditherStrength;\n  uniform float u_bitDepth;\n  uniform vec2 u_resolution;\n  uniform int u_debugMode; // 0 normal, 1 show UV\n\n  float bayer4(ivec2 p){\n    int x = p.x & 3; int y = p.y & 3; int idx = x + y*4;\n    float m[16] = float[](0.,8.,2.,10.,12.,4.,14.,6.,3.,11.,1.,9.,15.,7.,13.,5.);\n    return m[idx] / 16.0;\n  }\n  float hash(vec2 p){ return fract(sin(dot(p, vec2(127.1,311.7))) * 43758.5453123); }\n\n  vec3 applyDither(vec3 color, ivec2 fragCoord){\n    if(u_ditherType == 1){ float d = bayer4(fragCoord) - 0.5; return clamp(color + d * u_ditherStrength, 0.0, 1.0); }\n    if(u_ditherType == 2){ float n = hash(vec2(fragCoord)) - 0.5; return clamp(color + n * u_ditherStrength, 0.0, 1.0); }\n    return color;\n  }\n\n  vec3 quantizeBits(vec3 color, float bits){\n    float levels = pow(2.0, bits) - 1.0;\n    return floor(color * levels + 0.5) / levels;\n  }\n\n  vec3 paletteNearest(vec3 color, int paletteSize){\n    if(paletteSize <= 0) return color;\n    float bestDist = 1e9; vec3 bestCol = vec3(0.0);\n    for(int i=0;i<64;++i){\n      if(i>=paletteSize) break;\n      vec3 p = texelFetch(u_palette, ivec2(i,0), 0).rgb;\n      float d = distance(p, color);\n      if(d < bestDist){ bestDist = d; bestCol = p; }\n    }\n    return bestCol;\n  }\n\n  void main(){\n    if(u_debugMode == 1){\n      fragColor = vec4(v_uv, 0.0, 1.0);\n      return;\n    }\n    ivec2 fragCoord = ivec2(gl_FragCoord.xy);\n    vec3 c = texture(u_image, v_uv).rgb;\n    c = applyDither(c, fragCoord);\n    if(u_paletteSize > 0){\n      vec3 pal = paletteNearest(c, u_paletteSize);\n      fragColor = vec4(pal, 1.0);\n    } else {\n      vec3 q = quantizeBits(c, u_bitDepth);\n      fragColor = vec4(q, 1.0);\n    }\n  }\n");program=createProgram(e,t);const r=gl.createVertexArray();gl.bindVertexArray(r);const a=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,-1,1,0,1,1,-1,1,0,1,1,1,1]),n=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,n),gl.bufferData(gl.ARRAY_BUFFER,a,gl.STATIC_DRAW);const l=gl.getAttribLocation(program,"a_pos"),o=gl.getAttribLocation(program,"a_uv");gl.enableVertexAttribArray(l),gl.vertexAttribPointer(l,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(o),gl.vertexAttribPointer(o,2,gl.FLOAT,!1,16,8),imageTexture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,imageTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),paletteTexture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,paletteTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.useProgram(program),gl.uniform1i(gl.getUniformLocation(program,"u_image"),0),gl.uniform1i(gl.getUniformLocation(program,"u_palette"),1),gl.uniform1i(gl.getUniformLocation(program,"u_debugMode"),0),gl.clearColor(0,0,0,1),checkGLError("initGL end")}function createShader(e,t){const r=gl.createShader(e);if(gl.shaderSource(r,t),gl.compileShader(r),!gl.getShaderParameter(r,gl.COMPILE_STATUS))throw console.error("Shader compile error:",gl.getShaderInfoLog(r)),new Error("Shader compile error");return r}function createProgram(e,t){const r=gl.createProgram();if(gl.attachShader(r,e),gl.attachShader(r,t),gl.linkProgram(r),!gl.getProgramParameter(r,gl.LINK_STATUS))throw console.error("Program link error:",gl.getProgramInfoLog(r)),new Error("Program link error");return r}function uploadImage(e){loadedImage=e,imageWidth=e.naturalWidth||e.width,imageHeight=e.naturalHeight||e.height;const t=parseFloat(scaleSlider.value)||1;canvas.width=Math.max(1,Math.floor(imageWidth*t)),canvas.height=Math.max(1,Math.floor(imageHeight*t)),gl.viewport(0,0,canvas.width,canvas.height),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,imageTexture),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e),checkGLError("texImage2D image"),info.textContent=imageWidth+" x "+imageHeight,requestRender()}async function computePaletteFromImage(e){const t=document.createElement("canvas");t.width=imageWidth,t.height=imageHeight;const r=t.getContext("2d");r.drawImage(loadedImage,0,0,imageWidth,imageHeight);const a=r.getImageData(0,0,imageWidth,imageHeight).data,n=Math.min(2500,Math.floor(imageWidth*imageHeight/10)||2e3),l=[];for(let e=0;e<n;e++){const e=4*Math.floor(Math.random()*(imageWidth*imageHeight));l.push([a[e]/255,a[e+1]/255,a[e+2]/255])}const o=Math.min(e,64);let i=[];for(let e=0;e<o;e++)i.push(l[Math.floor(Math.random()*l.length)].slice());for(let e=0;e<12;e++){const e=Array.from({length:o},()=>({sum:[0,0,0],count:0}));for(const t of l){let r=0,a=1e9;for(let e=0;e<o;e++){const n=(t[0]-i[e][0])**2+(t[1]-i[e][1])**2+(t[2]-i[e][2])**2;n<a&&(a=n,r=e)}e[r].sum[0]+=t[0],e[r].sum[1]+=t[1],e[r].sum[2]+=t[2],e[r].count++}let t=0;for(let r=0;r<o;r++){if(0===e[r].count)continue;const a=e[r].sum[0]/e[r].count,n=e[r].sum[1]/e[r].count,l=e[r].sum[2]/e[r].count;t+=Math.abs(a-i[r][0])+Math.abs(n-i[r][1])+Math.abs(l-i[r][2]),i[r][0]=a,i[r][1]=n,i[r][2]=l}if(t<1e-5)break}for(;i.length<o;)i.push([0,0,0]);return i}function uploadPalette(e){const t=e.length,r=new Uint8Array(4*t);for(let a=0;a<t;a++)r[4*a+0]=Math.round(255*clamp(e[a][0],0,1)),r[4*a+1]=Math.round(255*clamp(e[a][1],0,1)),r[4*a+2]=Math.round(255*clamp(e[a][2],0,1)),r[4*a+3]=255;gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,paletteTexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,e.length,1,0,gl.RGBA,gl.UNSIGNED_BYTE,r),checkGLError("texImage2D palette")}function render(){if(!gl||!loadedImage)return;gl.useProgram(program),gl.viewport(0,0,canvas.width,canvas.height),gl.clear(gl.COLOR_BUFFER_BIT);const e=Math.round(expMap(parseFloat(bitDepthSlider.value),1,8)),t="auto"===paletteMode.value?Math.round(expMap(parseFloat(paletteSizeSlider.value),2,64)):0;gl.uniform1f(gl.getUniformLocation(program,"u_bitDepth"),e),gl.uniform1i(gl.getUniformLocation(program,"u_paletteSize"),t),gl.uniform1i(gl.getUniformLocation(program,"u_ditherType"),parseInt(ditherType.value)),gl.uniform1f(gl.getUniformLocation(program,"u_ditherStrength"),parseFloat(ditherStrength.value)),gl.uniform2f(gl.getUniformLocation(program,"u_resolution"),canvas.width,canvas.height),gl.uniform1i(gl.getUniformLocation(program,"u_debugMode"),debugShowUV?1:0);const r="nearest"===filterMode.value?gl.NEAREST:gl.LINEAR;gl.bindTexture(gl.TEXTURE_2D,imageTexture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,r),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,r),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,imageTexture),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,paletteTexture),gl.drawArrays(gl.TRIANGLES,0,6),checkGLError("drawArrays")}let _renderPending=!1;function requestRender(){_renderPending||(_renderPending=!0,requestAnimationFrame(()=>{_renderPending=!1,onBeforeRender().then(()=>render())}))}async function onBeforeRender(){if(!loadedImage)return;if("auto"===paletteMode.value){const e=Math.round(expMap(parseFloat(paletteSizeSlider.value),2,64));paletteSizeVal.textContent=e;uploadPalette(await computePaletteFromImage(e))}else{paletteSizeVal.textContent="—";const e=new Uint8Array([0,0,0,255]);gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,paletteTexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,e)}}fileInput.addEventListener("change",async e=>{const t=e.target.files&&e.target.files[0];if(!t)return;const r=new Image;r.onload=()=>{uploadImage(r)},r.src=URL.createObjectURL(t)}),bitDepthSlider.addEventListener("input",()=>{const e=Math.round(expMap(parseFloat(bitDepthSlider.value),1,8));bitDepthVal.textContent=e,requestRender()}),paletteSizeSlider.addEventListener("input",()=>{const e=Math.round(expMap(parseFloat(paletteSizeSlider.value),2,64));paletteSizeVal.textContent=e,requestRender()}),ditherStrength.addEventListener("input",()=>{ditherStrengthVal.textContent=parseFloat(ditherStrength.value).toFixed(2),requestRender()}),ditherType.addEventListener("change",()=>requestRender()),paletteMode.addEventListener("change",()=>requestRender()),scaleSlider.addEventListener("input",()=>{loadedImage&&uploadImage(loadedImage)}),filterMode.addEventListener("change",()=>requestRender()),fitBtn.addEventListener("click",()=>{if(!loadedImage)return;const e=canvas.parentElement,t=e.clientWidth,r=e.clientHeight,a=imageWidth/imageHeight;let n=t,l=Math.floor(n/a);l>r&&(l=r,n=Math.floor(l*a)),canvas.style.width=n+"px",canvas.style.height=l+"px"}),exportBtn.addEventListener("click",()=>{if(canvas.width&&canvas.height){try{const e=new Uint8Array(4);gl.readPixels(Math.max(0,Math.floor(canvas.width/2)),Math.max(0,Math.floor(canvas.height/2)),1,1,gl.RGBA,gl.UNSIGNED_BYTE,e),console.log("Center pixel RGBA (readPixels):",e)}catch(e){console.warn("readPixels failed",e)}canvas.toBlob(e=>{const t=document.createElement("a");t.href=URL.createObjectURL(e),t.download="dithered.png",t.click()},"image/png")}else console.warn("Export skipped: canvas size is zero")}),debugUVBtn.addEventListener("click",()=>{debugShowUV=debugShowUV?0:1,console.log("debugShowUV",debugShowUV),requestRender()}),logPixelBtn.addEventListener("click",()=>{if(canvas.width&&canvas.height)try{const e=new Uint8Array(4);gl.readPixels(Math.max(0,Math.floor(canvas.width/2)),Math.max(0,Math.floor(canvas.height/2)),1,1,gl.RGBA,gl.UNSIGNED_BYTE,e),console.log("Center pixel RGBA (manual):",e)}catch(e){console.warn("readPixels failed",e)}else console.warn("canvas size zero")}),initGL(),bitDepthVal.textContent=Math.round(expMap(parseFloat(bitDepthSlider.value),1,8)),paletteSizeVal.textContent=Math.round(expMap(parseFloat(paletteSizeSlider.value),2,64)),ditherStrengthVal.textContent=parseFloat(ditherStrength.value).toFixed(2)</script></body></html>